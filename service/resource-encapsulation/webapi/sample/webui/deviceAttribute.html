<!doctype html>
<html>
 <head>
	<link rel="icon" type="image/png" href="images/Favicon.png">
	<link rel="stylesheet" type="text/css" href="scripts/style.css">
	<script src="socket.io/socket.io.js"></script>  
    <script src="scripts/jquery.js"></script>	
 </head>

<script> 

var reqGetAttrId=0;
var requestGetAttrMap={};
var reqSetAttrId=0;
requestSetAttrMap={};
var PROFILING_ENABLED=1;
var attributeItems={};
var handle = location.search.replace(/^.*?\=/, '');
var obj = {};
obj["Handle"]=handle;

function post_Access_Request_Log()
{
	if(PROFILING_ENABLED == 1)
	{
		reqGetAttrId++;
		var curTime=new Date().getTime();
		
		var requestTime = {"id" : reqGetAttrId, "time" : curTime} ;
		
		requestGetAttrMap[handle] = requestTime;
		
		console.log("[PROFILING][GET ATTR] [ReqId] = "+reqGetAttrId+  " [Time] = "+curTime);
	}
}

function post_Access_Response_Log()
{
	if(PROFILING_ENABLED == 1)
	{
		var requestTime = requestGetAttrMap[handle];
		var curTime=new Date().getTime();
		
		var totalTime = curTime - requestTime.time;
		console.log("[PROFILING][GET ATTR] [RespId] = "+requestTime.id+  " [Time] = "+curTime + " [TotalTime] = " + totalTime + " ms");
	}
}

function post_Set_Request_Log()
{
	if(PROFILING_ENABLED == 1)
	{
		reqSetAttrId++;
		var curTime = new Date().getTime();
		
		var requestTime = {"id" : reqSetAttrId, "time" : curTime} ;
		
		requestSetAttrMap[handle] = requestTime;
		
		console.log("[PROFILING][SET ATTR] [ReqId] = "+reqSetAttrId+  " [Time] = "+curTime);
	}
}

function post_Set_Response_Log()
{
	if(PROFILING_ENABLED == 1)
	{
		var requestTime = requestSetAttrMap[handle];
		var curTime=new Date().getTime();
		
		var totalTime = curTime - requestTime.time;
		
		console.log("[PROFILING][SET ATTR] [RespId] = "+requestTime.id+  " [Time] = "+curTime + " [TotalTime] = " + totalTime + " ms");
	}
					
}
		
	
function list_create()
{    
	$("#headValue").hide();
	$("#getRemoteValues").hide();
	$("#getCachedValues").hide();
	$("#set").hide();
	$("#attribute").hide();
	$("#value").hide();
	$("#text").hide();
	$("#text1").hide();
	$("#text2").hide();
	$("#monitor").hide();
	$("#monitorLabel").hide();
	$("#activeCaching").hide();
	$("#passiveCaching").hide();
	$("#activeCachingLabel").hide();
	$("#passiveCachingLabel").hide();
	$("#status").hide();
	$("#statusField").hide();
	$("#address").hide();
	$("#addressField").hide();
	$("#type").hide();
	$("#typeField").hide();
	

	var locate = location.host;
	var url = "http://" + locate+"/getremoteattr";
	posting=$.post( url,JSON.stringify(obj));   post_Access_Request_Log();
	
	
	$("#wait").css("display", "block");
	 
	var attributeNames=[] ;
	var attributeValues=[];
	
	posting.done(function( data ) 
	{	
		post_Access_Response_Log();
	
		$("#wait").css("display", "none");
		attributeItems=data;
	
		var name=data["Name"];
		var path="images/" + name+".png";
		var img= '<img src="'+path+'" style="height:30px;width:30px;padding:5px 10px" align="left" id="img1">    <img id="statusImage" src="images/Alive.png" style="height:20px;width:20px;padding: 5px 10px" align="right" id="img2">';
		 
		$("#headValue").html(data["Name"]+img );
		  
		if(data["Status"]!=undefined){	
			$("#status").attr("placeholder",data["Status"]);
			updateStatus();
		}
		
		if(data["Address"]!=undefined){	
			$("#address").attr("placeholder",data["Address"]);
			$("#address").attr("title",data["Address"]);
		}
		
		if(data["Type"]!=undefined){	
			$("#type").attr("placeholder",data["Type"]);
			$("#type").attr("title",data["Type"]);

		}
		
		$("#headValue").show();
		$("#status").show();
		$("#statusField").show();
		$("#address").show();
		$("#addressField").show();
		$("#type").show();
		$("#typeField").show();			
		
		var obj=data["Attributes"];
		var loopVar=0;

		for (var key in obj) 
		{ 	
		  if (obj.hasOwnProperty(key)) 
		  {
			attributeNames[loopVar]=key;
			attributeValues[loopVar]=obj[key];
		  }
		  loopVar++;
		}
		
		for (var i in attributeNames) 
		{
			var txt = document.createTextNode(attributeNames[i]+"   ");
			var div = $("<div />");
			div.html(GetDynamicTextBox(attributeNames[i],attributeValues[i],typeof(attributeValues[i])));
			$("#TextBoxContainer").append(div);	
		}	

		$("#text").show();
		$("#text1").show();
		$("#text2").show();
		$("#attribute").show();
		$("#value").show();
		$("#set").show();
		$("#getRemoteValues").show();
		$("#getCachedValues").show();
		$("#monitor").show();
		$("#monitorLabel").show();
		$("#activeCaching").show();
		$("#passiveCaching").show();
		$("#activeCachingLabel").show();
        $("#passiveCachingLabel").show();
		
		$("#headValue").prop('disabled', true);	
		$("#set").prop('disabled', true);	
	});
}

function GetDynamicTextBox(key,value,type) {
    return '<input title="'+key+'" name = "DynamicTextBox"  class="placeHolder" type="text" size="9"  placeholder = "' + key + '" onclick=setAttField(placeholder) readonly />&nbsp;'  +
           '<input title="'+value+'" name = "'+type+'" class="placeHolder" type="text" size="15" id="' + key + '"  placeholder = "' + value + '" readonly />&nbsp;'+
		   '<br>'
}

function setAttField(value,pos){

	$("#attribute").val(value);
	$("#attribute").attr("title",value);
	var defaultVal = 0;
	$("#value").val(defaultVal);
	$("#set").prop('disabled', false);
}

function FindLength(data)
{
	var length =0;
	for (var key in data) 
	{
		length++;
	}
	return length;
}


function setAttributes(){
	
	var locate = location.host;
	var url = "http://" + locate + "/setattr";
	
	var tempAttrItems=attributeItems;
    
	var typeCheck="#"+$("#attribute").val();
	
	if($(typeCheck).attr('name')=="boolean")
	{
		if($("#value").val()=="true")
			tempAttrItems["Attributes"][$("#attribute").val()]=Boolean(1);
		else
			tempAttrItems["Attributes"][$("#attribute").val()]=Boolean(0);
	}
	else if($(typeCheck).attr('name')=="string")
	{
		tempAttrItems["Attributes"][$("#attribute").val()]=String($("#value").val());
	}
	else 
	{
		tempAttrItems["Attributes"][$("#attribute").val()]=Number($("#value").val());
	}
	
    var posting = $.post( url, JSON.stringify(tempAttrItems) );
	post_Set_Request_Log();
	
	posting.done(function( data ) 
	{		
		post_Set_Response_Log();
		var len = FindLength(data.Attributes);
		if(len != 0)
		{
			attributeItems=data;
			updateAttributes();
		}
	});
}


function updateAttributes()
{
	var tempAttrItems=attributeItems["Attributes"];
	var attributeNames=[];
	var attributeValues=[];
	var loopVar=0;
	for (var key in tempAttrItems) 
	{ 	
	  if (tempAttrItems.hasOwnProperty(key)) 
	  {
		attributeNames[loopVar]=key;
		attributeValues[loopVar]=tempAttrItems[key];
	  }
	  loopVar++;
	}
			
	for (var i in attributeNames) 
	{
		var id="#"+attributeNames[i];
		$(id).attr("placeholder",attributeValues[i]);
		$(id).attr("title",attributeValues[i]);		
	}
	updateStatus();				
}


function startMonitoring(id){
	var status=document.getElementById(id);
	var locate = location.host;
	var url = "http://" + locate;
	if(status.checked)
	{
		var socket = io.connect(url);
		socket.emit('start-monitor', JSON.stringify(attributeItems));
		socket.on('monitor-response', function(data) {
		
			if(data["Status"]!=undefined){	
				attributeItems["Status"] = data["Status"];
				updateStatus();	
			}	
		});
	}
	else
	{	
	    var socket = io.connect(url);
		socket.emit('stop-monitor', JSON.stringify(attributeItems));
	}
}

function updateStatus(){
	
	if(attributeItems["Status"]==0){ 
	$("#statusImage").attr("src","images/None.png");
	$("#status").attr("placeholder","None");
	$("#status").attr("title","None");
	}
	else if(attributeItems["Status"]==1){ 
	$("#statusImage").attr("src","images/Alive.png");
	$("#status").attr("placeholder","Alive");
	$("#status").attr("title","Alive");
	}
	else if(attributeItems["Status"]==2){ 
	$("#statusImage").attr("src","images/Requested.png");
	$("#status").attr("placeholder","Waiting..");
	$("#status").attr("title","Waiting..");
	}
	else if(attributeItems["Status"]==3){ 
	$("#statusImage").attr("src","images/LostSignal.png");
	$("#status").attr("placeholder","Signal Lost");
	$("#status").attr("title","Signal Lost");
	}
	else if(attributeItems["Status"]==4){ 
	$("#statusImage").attr("src","images/Dead.png");
	$("#status").attr("placeholder","Destroyed");
	$("#status").attr("title","Destroyed");
	}	
}

function activeStartCaching(id){
	var locate = location.host;
	var url = "http://" + locate;
	var status=document.getElementById(id);
	if(status.checked)
	{	
		$("#passiveCaching").prop('disabled', true);	
		var socket = io.connect(url);
		socket.emit('active-start-caching', JSON.stringify(obj));
		socket.on('caching-response', function(data) {
			var len = FindLength(data.Attributes);
			if(len != 0)
			{
				attributeItems=data;
				updateAttributes();
			}
		});
	}
	else
	{  
		$("#passiveCaching").prop('disabled', false);
		var socket = io.connect(url);
		socket.emit('stop-caching', JSON.stringify(obj));	
	}
}

function passiveStartCaching(id){
	var locate = location.host;
	var url = "http://" + locate;
	var status=document.getElementById(id);
	if(status.checked)
	{	
		$("#activeCaching").prop('disabled', true);
		var socket = io.connect(url);
		socket.emit('passive-start-caching', JSON.stringify(obj));
	
	}
	else
	{  
		$("#activeCaching").prop('disabled', false);
		var socket = io.connect(url);
		socket.emit('stop-caching', JSON.stringify(obj));	
	}
}

function getRemoteAttributes(){
	var locate = location.host;
	var url = "http://" + locate+"/getremoteattr";
		
	posting=$.post( url,JSON.stringify(obj));   
	post_Access_Request_Log();
	
	posting.done(function( data ) 
	{		
		post_Access_Response_Log();
		var len = FindLength(data.Attributes);
		if(len != 0)
		{
			attributeItems=data;
			updateAttributes();
		}
	});
}


function getCachedAttributes(){
	var locate = location.host;
	var url = "http://" + locate+"/getcachedattr";
		
	posting=$.post( url,JSON.stringify(obj));   
	post_Access_Request_Log();
	
	posting.done(function( data ) 
	{		
		post_Access_Response_Log();
		var len = FindLength(data.Attributes);
		if(len != 0)
		{
			attributeItems=data;
			updateAttributes();
		}
	});
}

</script>
<title>IoTivity Smart Home Demo</title>   
 <div class="container" border="width:5px;style:solid color:red">  
<body onload="list_create()">
    <header>
		<h1>
			<p class="p1" align="center" style="color:#007D7D;font-family:verdana"> Smart Home</p>	
		</h1>
		<h4>
			<p class="p1" align="center" style="color:#335C33;font-family:verdana">Access And Monitor Your Appliances</p>
		</h4>	
	</header>
	<br>
	
	<p>
	<button style="font-family:verdana;width:200px;height:50px;textAlign:center;fontSize: 20px;font-weight: bold" class="btn" id="headValue" /><b> </b></button>
	</p>

	<form>
		<label for="monitor" id="monitorLabel" style="font-family:verdana;font-size:12px;font-weight: bold"><input type="checkbox" class="checkboxes" id="monitor" onclick="startMonitoring(id)" > Resource Monitoring </label><br><br>
		<label for="caching" id="activeCachingLabel" style="font-family:verdana;font-size:12px;font-weight: bold"><input type="checkbox" class="checkboxes" id="activeCaching" onclick="activeStartCaching(id)" > Active Resource Caching</label> 
		<label for="caching" id="passiveCachingLabel" style="font-family:verdana;font-size:12px;font-weight: bold"><input type="checkbox" class="checkboxes" id="passiveCaching" onclick="passiveStartCaching(id)" > Passive Resource Caching</label>
		<br><br>
	</form> 


	<div id="TextContainer" style="font-family:verdana;  outline:none; border:none; border-style: none;">
		<p id="text"><font color="brown"> <b> Device Information </b></font></p> 
   
		<input title="Status" id="statusField" class="placeHolder" type="text" size="9"  placeholder = "Status" readonly />  <input class="placeHolder" id= "status" type="text" size="15" placeholder = "NULL" readonly /> <br>

		<input  title="Address" id= "addressField" class="placeHolder" type="text" size="9"  placeholder = "Address" readonly />  <input class="placeHolder" id= "address" type="text" size="15" placeholder = "NULL" readonly /> <br>

		<input  title="Type" id= "typeField" class="placeHolder" type="text" size="9"  placeholder = "Type" readonly />  <input class="placeHolder" id= "type" type="text" size="15" placeholder = "NULL" readonly /> <br>
	
	</div>
	<br>


	<div id="TextBoxContainer" style="font-family:verdana">
	<p id="text1"><font color="brown"><b> Device Attributes </b></font>
		<!--Attribute Textboxes will be dynamically added here -->
	</div><br>
	
	<p>
	<button style="font-family:verdana;font-size:12px;text-align:center;width:170px;height:40px;font-weight: bold" class="btn" id="getRemoteValues" onclick="getRemoteAttributes()" />Get Remote Values</button>&nbsp;
	<button style="font-family:verdana;font-size:12px;text-align:center;width:170px;height:40px;font-weight: bold" class="btn" id="getCachedValues" onclick="getCachedAttributes()" />Get Cached Values</button><br><br>
	</p>

	<p style="font-family:verdana" id="text2" > <font color="brown"> <b>Set Attribute Value</b></font><br>
	<font size="2px" color="red">(Click on attribute name from above device attribute list)</font></p></p> 

	<input style="font-family:verdana;font-weight: bold" id="attribute" type="text" name="text" size="9" placeholder="Attribute" readonly />	<input style="font-family:verdana;font-weight: bold" id="value" type="text" name="text" size="15" placeholder="Value" /><br>


	<p>
	<button style="font-family:verdana;font-size:12px;text-align:center;width:170px;height:40px;font-weight: bold" class="btn" id="set" onclick="setAttributes()" />Set Remote Values</button> <br><br><br><br>
	</p>

	<div id="wait" style="display:none;width:69px;height:89px; solid black;position:absolute;top:50%;left:45%;padding:2px"><img src='images/Loading.gif' width="64" height="64" /><br>Loading..</div>
</body>
</div>
</html>
