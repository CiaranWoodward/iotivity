*** Settings ***
Documentation	CT1.3.10 Partial NON UPDATE Message based on CoAP
Resource	OIC_ConformanceTest_Setting.txt
Test Setup    Start Capture
Test TearDown    End Capture

*** Test Cases ***
CT1.3.10 Partial NON UPDATE Message based on CoAP
    [Documentation]					
	...	|author	| |		
	...	|reviewer| |				
	...	|since	|2015-05-11|
	...	|see	|Section 11.2 : CoAP based endpoint discovery|
	...	|objective	|Verify that the server (DUT) properly responds to a complete CON UPDATE request message from client (TE) with a subset of representation of the resource |
	...	|target	|Server DUT |
	...	|test_data	|NON UPDATE Message based on CoAP |
	...	|pre_condition	|Server (DUT) is discoverable from the Client (TE) |
	...	|pre_condition	|Resource properties and attribute contents are known for verification |
	...	|procedure	|1. Send a partial CON UPDATE (high QoS) request message to server |
	...	|procedure	|2. Reply with UPDATE response message to client |
	...	|procedure	|3. Receive UPDATE response message from server |
        ...     |procedure      |4. Send a GET to the same resource(DUT) |
        ...     |procedure      |5. Reply with GET response |
        ...     |procedure      |6. Repeat the steps 1 through 5 |
	...	|post_condition	| |
	...	|expected|Server sends the response message including below |
	...	|expected|1. OIC Layer |
	...	|expected| - fr, to, ri, rs |
	...	|expected|2. CoAP Layer |
	...	|expected| - Type = 1 (NON) |
	...	|expected| - Token = Token in request |
	...	|expected| - Resp Code = 2.04 (Changed) |


    [Tags]	Mandatory	Server    Update
#Pre-Condtion
    Set Log File Directory	${TESTNAME}
    ${DUT1_ID} =	Set Variable	Server_DUT1
    ${define_dut_result}	Define DUT Information		${DUT1_ID}	${DUT1_INFO_PATH}	${DUT_TYPE_SERVER}
    Should Be True	${define_dut_result}
    @{dut1_resource_types}	Get DUT Info Value	${RESOURCE_TYPE}	${DUT1_ID}	${DISCOVERABLE}=1
    ${resource_ip}	${resource_port}	${resource_href}	Get IP Port And Uri		${RESOURCE_TYPE}=${dut1_resource_types[0]}
    @{dut1_resource_hrefs}      Get DUT Info Value      ${HREF}    ${DUT1_ID}   ${DISCOVERABLE}=1
    :FOR	${resource_href}	IN	@{dut1_resource_hrefs}
    \   ${length}    Get Length Available Representation To Update    ${DUT1_ID}      ${DISCOVERABLE}=1&${HREF}=${resource_href}
    \   Continue For Loop If    ${length} < 1
    \	Set Modified Partial Representation Value Payload       ${DUT1_ID}      ${DISCOVERABLE}=1&${HREF}=${resource_href}
    \	${payload}	Get Json Representation
    \   ${msgid}    Generate Message Id
    \   ${token}    Generate Token
    \	${dut2_response}	Send Post Request	${UNICAST}	${COAP}	${msgid}	${token}	${resource_ip}	${${resource_port}}	${resource_href}	${NON_CONFIRMABLE}	${payload}
    \	${update_support}    Is Crudn Operation Supported    ${resource_href}    ${PARTIAL_UPDATE}
    \	Should Not Be Empty		${dut2_response}
    \	${dut2_response_json}	Run Keyword if    ${update_support} == ${True}    Get Response Json	${dut2_response}
    \	${validate_json_result}	Run Keyword if    ${update_support} == ${True}    Validate JSON Format        ${dut2_response_json}
    \	Run Keyword if    ${update_support} == ${True}    Should Be True	${validate_json_result}
    \	${dut2_response_code}    Get Response Code       ${dut2_response}
    \	${dut2_response_token}    Get Response Token       ${dut2_response}
    \	Should Be Equal             ${dut2_response_token}    ${token}
    \	Run Keyword if    ${update_support} == ${True}    Should Be Equal	${COAP_RESPONSE_CODE_UPDATED}	${dut2_response_code}
    \	Run Keyword if    ${update_support} == ${False}    Should Be Equal    ${COAP_RESPONSE_CODE_ERROR}    ${dut2_response_code}
    \	${dut2_payload}    Run Keyword if    ${update_support} == ${True}    Get Response Json	${dut2_response}
    \	Run Keyword if    ${update_support} == ${True}    Check Modified Partial Representation Value     ${DUT1_ID}      ${DISCOVERABLE}=1&${HREF}=${resource_href}      ${dut2_payload}
    \   ${msgid}    Generate Message Id
    \   ${token}    Generate Token
    \	${dut2_response}	Send Get Request	${UNICAST}	${COAP}	${msgid}	${token}	${resource_ip}	${${resource_port}}	${resource_href}    ${NON_CONFIRMABLE}
    \	Should Not Be Empty		${dut2_response}
    \	${duty_response_type}	Get Response Type	${dut2_response}
    \	Should Be Equal    ${duty_response_type}	${NON}   
    \	${dut2_response_code}    Get Response Code       ${dut2_response}
    \	${dut2_response_token}    Get Response Token       ${dut2_response}
    \	Should Be Equal             ${dut2_response_token}    ${token}
    \	${dut2_response_msgid}   Get Response Msgid       ${dut2_response}
    \	Should Be Equal             ${dut2_response_msgid}    ${msgid}
    \	Should Be Equal    ${COAP_RESPONSE_CODE_RETRIEVED}    ${dut2_response_code}
    \	${dut2_response_json}	Get Response Json	${dut2_response}
    \	${validate_json_result}    Validate JSON Format        ${dut2_response_json}
    \	Should Be True	${validate_json_result}
    \	Run Keyword if    ${update_support} == ${True}    Check Modified Partial Representation Value     ${DUT1_ID}      ${DISCOVERABLE}=1&${HREF}=${resource_href}      ${dut2_response_json}
     Release DUT information     ${DUT1_ID}

