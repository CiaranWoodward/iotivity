*** Settings ***
Documentation	CT1.3.1 CON CREATE Message based on CoAP
Resource	OIC_ConformanceTest_Setting.txt
Test Setup    Start Capture
Test TearDown    End Capture

*** Test Cases ***
CT1.3.1 CON CREATE Message based on CoAP
    [Documentation]					
	...	|author	| |		
	...	|reviewer| |				
	...	|since	|2015-05-11 |
	...	|see	|Section 8.1: CREATE |
	...	|objective|Verify that the server (DUT) properly responds to CON CREATE request message from client (TE) |
	...	|target	|Server DUT | 
	...	|test_data|CON CREATE Message based on CoAP |
	...	|pre_condition	|Server (DUT) is discovered from the Client (TE) Resource properties and attribute contents are known for verification |
	...	|procedure	|1. Send CON (high QoS) CREATE request message with a complete URI to server |
	...	|procedure	|2. Reply with CREATE response message to client |
	...	|procedure	|3. Receive CREATE response message from server and reply a Ack |
	...	|post_condition	|Remove created resource |
	...	|expected|1. OIC Layer |
	...	|expected| -  fr, to, ri, cn. rs |
	...	|expected| -  cn includes the URI and the resource representation of the created resource |
	...	|expected|2. CoAP Layer |
	...	|expected| - Type = 3 (Ack) |
	...	|expected| - Token = Token in request |
	...	|expected| - MsgId = MsgId in request |
	...	|expected| - Resp Code = 2.01 (Created) |

    [Tags]	Mandatory	Server	Discovery
#Pre-Condition
    Set Log File Directory	${TESTNAME}
    ${DUT1_ID} =	Set Variable	Server_DUT1
    ${define_dut_result}	Define DUT Information		${DUT1_ID}	${DUT1_INFO_PATH}	${DUT_TYPE_SERVER}
    Should Be True	${define_dut_result}
    @{dut1_resource_types}	Get DUT Info Value	${RESOURCE_TYPE}	${DUT1_ID}	${DISCOVERABLE}=1
    :FOR       ${dut1_resource_type}   IN      @{dut1_resource_types}
    \	${resource_ip}	${resource_port}	${resource_href}	Get IP Port And Uri		${RESOURCE_TYPE}=${dut1_resource_type}
#Test-Body
    \	Create Json Representation
    \	Add Into Json Representation    ${RESOURCE_TYPE}        ${dut1_resource_type}
    \	Add Into Json Representation    ${HREF}		 ${resource_href}${CREATED_HREF}
    \	${payload}      Get Json Representation
    \   ${msgid}    Generate Message Id
    \   ${token}    Generate Token
    \	${dut2_response}        Send Put Request        ${UNICAST}      ${COAP}    ${msgid}    ${token}    ${resource_ip}	  ${${resource_port}}     ${resource_href}        ${CONFIRMABLE}  ${payload}
    \	${create_support}    Is Crudn Operation Supported    ${resource_href}    ${COMPLETE_CREATE}
    \	Should Not Be Empty             ${dut2_response}
    \	${duty_response_type}	Get Response Type	${dut2_response}
    \	Should Be Equal	${duty_response_type}	${ACK}
    \	${dut2_response_code}   Get Response Code       ${dut2_response}
    \	Run Keyword if    ${create_support} == ${True}    Should Be Equal 	${COAP_RESPONSE_CODE_CREATED}   ${dut2_response_code}
    \	Run Keyword if    ${create_support} == ${False}    Should Be Equal 	${COAP_RESPONSE_CODE_ERROR}   ${dut2_response_code}
    \	${dut2_response_token}   Get Response Token       ${dut2_response}
    \	Should Be Equal             ${dut2_response_token}    ${token}
    \	${dut2_response_msgid}   Get Response Msgid       ${dut2_response}
    \	Should Be Equal             ${dut2_response_msgid}    ${msgid}
    \	${dut2_response_json}	Run Keyword if    ${create_support} == ${True}    Get Response Json       ${dut2_response}
    \	@{dut2_response_href}	Run Keyword if    ${create_support} == ${True}    Get Json Value          ${HREF}         ${dut2_response_json}
    \	Run Keyword if    ${create_support} == ${True}    Should Be Equal    @{dut2_response_href}[0]    ${resource_href}${CREATED_HREF}
#Post-Condition
    \   ${msgid}    Run Keyword if    ${create_support} == ${True}    Generate Message Id
    \   ${token}    Run Keyword if    ${create_support} == ${True}    Generate Token
    \	${dut2_response}    Run Keyword if    ${create_support} == ${True}    Send Delete Request     ${UNICAST}      ${COAP}    ${msgid}    ${token}         ${resource_ip}       ${${resource_port}}    ${resource_href}${CREATED_HREF}         ${CONFIRMABLE}
    \	Run Keyword if    ${create_support} == ${True}    Should Not Be Empty         ${dut2_response}
    \	${dut2_response_json}       Run Keyword if    ${create_support} == ${True}    Get Response Json       ${dut2_response}
    \	${validate_json_result}     Run Keyword if    ${create_support} == ${True}    Validate JSON Format        ${dut2_response_json}
    \	Run Keyword if    ${create_support} == ${True}    Should Be ${True}      ${validate_json_result}
    \	${dut2_response_code}       Run Keyword if    ${create_support} == ${True}    Get Response Code       ${dut2_response}
    \	Run Keyword if    ${create_support} == ${True}    Should Be Equal     ${COAP_RESPONSE_CODE_DELETED}   ${dut2_response_code}
    Release DUT information     ${DUT1_ID}

