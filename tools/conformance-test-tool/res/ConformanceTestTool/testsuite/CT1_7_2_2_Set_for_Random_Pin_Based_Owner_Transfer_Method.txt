*** Settings ***
Documentation	CT1.7.2.2 Set for Random Pin Based Owner Transfer Method
Resource	OIC_ConformanceTest_Setting.txt

*** Test Cases ***
CT1.7.2.2 Set for Random Pin Based Owner Transfer Method
    [Documentation]
	...	|author	| |
	...	|reviewer|	|
	...	|since	|2015-10-09 |
	...	|see	|Security Spec section 7.3.4 Random PIN Based Owner Transfer Method |
	...	|objective	| Verify the Server (DUT) accept the Random Pin Based OTM if the Server(DUT)  |
	...	|objective	| claims it supports Random Pin Based OTM in CT1.7.1. |
	...	|target	|Server DUT |
	...	|test_data| OxmSel == 1 (”oic.sec.doxm.rdp”) |
	...	|test_configuration| 1. Server (DUT) should be an ‘unowned’ state and support ‘Random Pin Based’ |
	...	|test_configuration| 2. Client (TE) should support ‘Random Pin Based’ OTM. |
	...	|pre_condition| CT1.7.1 is successfully finished. |
	...	|procedure| 1. Use the Test Application to  sends PUT req. to the Server(DUT) to choose “Random Pin Based” |	
	...	|procedure| 2. DUT sends reply to PUT request |
	...	|post_condition|None |
	...	|expected| 1. Client (TE) get RSP 2.04  |
	...	|expected| 2. Server’s (DUT) doxm.OxmSel property is 1 (“oic.sec.doxm.rdp”). "/oic/sec/doxm.OxmSel "  == 1 ("oic.sec.doxm.rdp") |

    [Tags]	Optional    Security
    
    Initialize Device Controller	${DEVICE_ID}
    Change Working Directory	${SECURITY_CLIENT_DIR}
    Execute Application	${SECURITY_CLIENT_PROCESS_ID}	${SECURITY_CLIENT}
    ConformanceKeyword.Log to Console	Starting Security Provisioning Client ...
    Start Application Log	${DEVICE_ID}	${SECURITY_CLIENT_PROCESS_ID}
    Sleep	5 seconds
    ConformanceKeyword.Log to Console	Discovering Unowned Devices ...
    Input Command To Application	${SECURITY_CLIENT_PROCESS_ID}	${INPUT_DISCOVERY_UNOWNED_DEVICE}
    Sleep	5 seconds
    ConformanceKeyword.Log to Console	Setting OxmSel to oic.sec.doxm.rdp ...
    Input Command To Application	${SECURITY_CLIENT_PROCESS_ID}	${INPUT_OWNER_TRANSFER}
    Sleep	3 seconds
    Input Command To Application	${SECURITY_CLIENT_PROCESS_ID}	${INPUT_DEVICE_SELECTION}
    ${random_pin}	Wait For User Confirmation	Please input the Random Pin generated in Server
    Input Command To Application	${SECURITY_CLIENT_PROCESS_ID}	${random_pin}
    Sleep	5 seconds
    Input Command To Application	${SECURITY_CLIENT_PROCESS_ID}	${INPUT_CLOSE_SECURITY_CLIENT}
    ${app_log}	Get Application Log	${DEVICE_ID}	${SECURITY_CLIENT_PROCESS_ID}
    Should Contain	${app_log}	Transferred Ownership successfuly for device
    ConformanceKeyword.Log to Console	${app_log}
    
    ${IS_RESOURCE_FOUND}	Set Variable	False
#    @{dut_response_list}	Get Multicast Discovery Request List	${COAP}	${OIC_CORE_PROVISION_URI}	${PROVISION_QUERY_OWNED}
    ${dut_response}	Get Multicast Discovery Request List	${COAP}	${OIC_CORE_PROVISION_URI}	${PROVISION_QUERY_OWNED}

    ${IS_RESOURCE_FOUND}	Set Variable	True
    ${dut_response_code}	${resource_ip}	${resource_port}	${response_payload}	Get Response Code IP Port And Payload From Response	${dut_response}
	Should Be Equal         ${COAP_RESPONSE_CODE_SUCCESS}   ${dut_response_code}
	${msgid2}    Generate Message Id
    ${token2}    Generate Token   
	${dut_get_response}    Send Get Request    ${UNICAST}    ${COAP}    ${msgid2}    ${token2}    ${resource_ip}    ${${resource_port}}    ${OIC_CORE_PROVISION_URI}?${PROVISION_QUERY_OWNED}    ${CONFIRMABLE}
	Should Not Be Empty             ${dut_get_response}
	${dut_get_response_code}   Get Response Code       ${dut_get_response}
	Should Be Equal         ${COAP_RESPONSE_CODE_SUCCESS}   ${dut_get_response_code}
	${dut_get_response_payload}	Get Response Payload	${dut_get_response}
	${oxmsel_property}	Get OXM Selection From Response	${dut_get_response_payload}
	Should Contain	${oxmsel_property}	${RANDOM_PIN_BASED_OTM}
	
#	    :FOR       ${dut_response}   IN      @{dut_response_list}
#    \	${IS_RESOURCE_FOUND}	Set Variable	True
#    \	${dut_response_code}	${resource_ip}	${resource_port}	${response_payload}	Get Response Code IP Port And Payload From Response	${dut_response}
#	\	Should Be Equal         ${COAP_RESPONSE_CODE_SUCCESS}   ${dut_response_code}
#    \   ${msgid2}    Generate Message Id
#    \   ${token2}    Generate Token   
#	\	${dut_get_response}        Send Get Request        ${UNICAST}      ${COAP}    ${msgid2}    ${token2} 	${resource_ip}	  ${${resource_port}}	${OIC_CORE_PROVISION_URI}?${PROVISION_QUERY_OWNED}	${CONFIRMABLE}
#	\	Should Not Be Empty             ${dut_get_response}
#	\	${dut_get_response_code}   Get Response Code       ${dut_get_response}
#	\	Should Be Equal         ${COAP_RESPONSE_CODE_SUCCESS}   ${dut_get_response_code}
#	\	${dut_get_response_payload}	Get Response Payload	${dut_get_response}
#	\	${oxmsel_property}	Get OXM Selection From Response	${dut_get_response_payload}
#	\	Should Contain	${oxmsel_property}	${RANDOM_PIN_BASED_OTM}

    Should be True	${IS_RESOURCE_FOUND}
    

