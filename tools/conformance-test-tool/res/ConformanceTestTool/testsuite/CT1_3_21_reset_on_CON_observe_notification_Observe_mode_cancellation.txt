*** Settings ***
Documentation	CT1.3.21 RESET on CON observe notification - Observe mode cancellation
Resource	OIC_ConformanceTest_Setting.txt
Test Setup    Start Capture
Test TearDown    End Capture

*** Test Cases ***
CT1.3.21 RESET on CON observe notification - Observe mode cancellation
    [Documentation]					
	...	|author	| |		
	...	|reviewer| |				
	...	|since	|2015-06-18|
	...	|see	|IETF draft-ietf-core-observe-16, Section 3.6|
	...	|objective|Verify the server (DUT) de-registers client from observer list if client (TE) sends a RESET upon receiving a CON observe notification from the server. |
	...	|target	||
	...	|test_data|CONFIRMABLE=1 |
	...	|pre_condition	|Server (DUT) is discoverable from the Client (TE)|
	...	|pre_condition	|Resource properties and attribute contents are known for verification |
	...	|pre_condition	|Server (DUT) is in observe mode |
	...	|procedure	|1. Observe condition satisfied |
	...	|procedure	|2. Reply with CON RETRIEVE response message to client |
	...	|procedure	|3. Upon receiving the response message, send a RESET message with the same token back |
	...	|procedure	|4. Cancel observation mode |
	...	|procedure	|5. Observe condition satisfied |
	...	|post_condition	| |
	...	|expected|1. Server doesnâ€™t re-transmit the response message |
	...	|expected|2. Client does not receive any RETRIEVE Response messages with observe indication |
	
    [Tags]	Mandatory	Server    Observe
    Set Log File Directory	${TESTNAME}
    ${DUT1_ID} =	Set Variable	Server_DUT1
    ${define_dut_result}	Define DUT Information		${DUT1_ID}	${DUT1_INFO_PATH}	${DUT_TYPE_SERVER}
    Should Be True	${define_dut_result}
    @{dut1_resource_types}  Get DUT Info Value      ${RESOURCE_TYPE}        ${DUT1_ID}      ${OBSERVABLE}=1&${DISCOVERABLE}=1
    ${resource_ip}  ${resource_port}        ${resource_href}        Get IP Port And Uri             ${RESOURCE_TYPE}=@{dut1_resource_types}[0]
    @{dut1_resource_hrefs}       Get DUT Info Value      ${HREF}    ${DUT1_ID}      ${OBSERVABLE}=1&${DISCOVERABLE}=1
    :FOR        ${resource_href}   IN      @{dut1_resource_hrefs}
    \   ${msgid1}    Generate Message Id
    \   ${token1}    Generate Token
    \	Send Observe Request	${COAP}	${msgid1}	${token1}	${resource_ip}	${${resource_port}}	${resource_href}	${CONFIRMABLE}
    \	Builtin.sleep	${${DEFAULT_WAIT_TIME}}
    \   ${length}    Get Length Available Representation To Update    ${DUT1_ID}      ${DISCOVERABLE}=1&${HREF}=${resource_href}
    \	Run Keyword If    ${length} > 0    Set Modified Partial Representation Value Payload       ${DUT1_ID}      ${DISCOVERABLE}=1&${HREF}=${resource_href}&${OBSERVABLE}=1
    \	${payload}	Run Keyword If    ${length} > 0    Get Json Representation
    \   ${msgid2}    Generate Message Id
    \   ${token2}    Generate Token
    \	${update_support}    Is Crudn Operation Supported    ${resource_href}    ${PARTIAL_UPDATE}
    \	${dut2_response}	Run Keyword If    ${length} > 0 and ${update_support} == ${True}    Send Post Request	${UNICAST}	${COAP}	${msgid2}	${token2}	${resource_ip}	${${resource_port}}	${resource_href}	${NON_CONFIRMABLE}	${payload}
    \	Builtin.sleep	${${DEFAULT_WAIT_TIME}}
    \	${dut2_response}	Get Observe Response	${COAP}
    \	Should Not Be Empty		${dut2_response}
    \	Cancel Observe Reset	${COAP}
    \   ${msgid3}    Generate Message Id
    \   ${token3}    Generate Token
    \	${dut2_response}	Run Keyword If    ${length} > 0 and ${update_support} == ${True}    Send Post Request	${UNICAST}	${COAP}	${msgid3}	${token3}	${resource_ip}	${${resource_port}}	${resource_href}	${NON_CONFIRMABLE}	${payload}
    \   ${msgid4}    Generate Message Id
    \   ${token4}    Generate Token
    \	${dut2_response}	Run Keyword If    ${length} > 0 and ${update_support} == ${True}    Send Post Request	${UNICAST}	${COAP}	${msgid4}	${token4}	${resource_ip}	${${resource_port}}	${resource_href}	${NON_CONFIRMABLE}	${payload}
    \   ${msgid5}    Generate Message Id
    \   ${token5}    Generate Token
    \	${dut2_response}	Run Keyword If    ${length} > 0 and ${update_support} == ${True}    Send Post Request	${UNICAST}	${COAP}	${msgid5}	${token5}	${resource_ip}	${${resource_port}}	${resource_href}	${NON_CONFIRMABLE}	${payload}
    \   ${msgid6}    Generate Message Id
    \   ${token6}    Generate Token
    \	${dut2_response}	Run Keyword If    ${length} > 0 and ${update_support} == ${True}    Send Post Request	${UNICAST}	${COAP}	${msgid6}	${token6}	${resource_ip}	${${resource_port}}	${resource_href}	${NON_CONFIRMABLE}	${payload}
    \	${dut2_response}	Get Observe Response	${COAP}
    \	Should Be Empty		${dut2_response}
    Release DUT information     ${DUT1_ID}

