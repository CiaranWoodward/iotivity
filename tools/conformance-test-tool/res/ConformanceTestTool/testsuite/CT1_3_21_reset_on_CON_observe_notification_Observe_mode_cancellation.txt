*** Settings ***
Documentation	CT1.3.21 RESET on CON observe notification - Observe mode cancellation
Resource	OIC_ConformanceTest_Setting.txt
Test Setup    Pre Condition Crudn Server
Test TearDown    Post Condition

*** Test Cases ***
CT1.3.21 RESET on CON observe notification - Observe mode cancellation
    [Documentation]
	...	|author	| |
	...	|reviewer| |
	...	|since	|2015-06-18|
	...	|see	|IETF draft-ietf-core-observe-16, Section 3.6|
	...	|objective|Verify the server (DUT) de-registers client from observer list if client (TE) sends a RESET upon receiving a CON observe notification from the server. |
	...	|target	||
	...	|test_data|CONFIRMABLE=1 |
	...	|pre_condition	|Server (DUT) is discoverable from the Client (TE)|
	...	|pre_condition	|Resource properties and attribute contents are known for verification |
	...	|pre_condition	|Server (DUT) is in observe mode |
	...	|procedure	|1. Observe condition satisfied |
	...	|procedure	|2. Reply with CON RETRIEVE response message to client |
	...	|procedure	|3. Upon receiving the response message, send a RESET message with the same token back |
	...	|procedure	|4. Cancel observation mode |
	...	|procedure	|5. Observe condition satisfied |
	...	|post_condition	| |
	...	|expected|1. Server doesnâ€™t re-transmit the response message |
	...	|expected|2. Client does not receive any RETRIEVE Response messages with observe indication |
	
    [Tags]	Mandatory	Server    Observe

    @{dut1_resource_hrefs}       Get DUT Info Value      ${HREF}    ${DUT1_ID}      ${OBSERVABLE}=1&${DISCOVERABLE}=1
    :FOR        ${resource_href}   IN      @{dut1_resource_hrefs}
    \   ${msgid1}    Generate Message Id
    \   ${token1}    Generate Token
    \	${dut2_response}    Send Observe Request	${COAP}	${msgid1}	${token1}	${SERVER_IP}    ${${SERVER_PORT}}    ${resource_href}	${CONFIRMABLE}
    \   Should Not Be Empty    ${dut2_response}    No response found for observe request
    \	${duty_response_type}	Get Response Type	${dut2_response}
    \	Should Be Equal    ${duty_response_type}    ${ACK}    Observe response type is not ACK
    \   ${dut2_response_code}   Get Response Code       ${dut2_response}
    \   Should Be Equal         ${COAP_RESPONSE_CODE_RETRIEVED}         ${dut2_response_code}     Response code mismatch for observe request
    \	${dut2_response_token}   Get Response Token       ${dut2_response}
    \	Should Be Equal             ${dut2_response_token}    ${token1}    Response token mismatch for observe request
    \	${dut2_response_msgid}   Get Response Msgid       ${dut2_response}
    \	Should Be Equal             ${dut2_response_msgid}    ${msgid1}    Response message id mismatch for observe request
    \	${dut2_response_json}	Get Response Json	${dut2_response}
    \	${validate_json_result}    Validate JSON Format        ${dut2_response_json}
    \	Should Be True    ${validate_json_result}    Json format of response payload is invalid
    \	${validate_payload_result}    Validate Payload Type        ${dut2_response_json}    ${resource_href}
    \	Should Be True    ${validate_payload_result}    Payload object type does not match with spec

    \   ${length}    Get Length Available Representation To Update    ${DUT1_ID}      ${DISCOVERABLE}=1&${HREF}=${resource_href}
    \   Run Keyword If    ${length} > 0    Set Modified Partial Representation Value Payload       ${DUT1_ID}      ${OBSERVABLE}=1&${HREF}=${resource_href}&${DISCOVERABLE}=1
    \   ${payload}    Run Keyword If    ${length} > 0    Get Json Representation
    \   ${msgid2}    Generate Message Id
    \   ${token2}    Generate Token
    \	${update_support}    Is Crudn Operation Supported    ${resource_href}    ${PARTIAL_UPDATE}
    \   Clear Notifications     ${COAP}
    \   ${dut2_response}    Run Keyword If    ${length} > 0 and ${update_support} == ${True}    Send Post Request        ${UNICAST}      ${COAP}    ${msgid2}       ${token2}       ${SERVER_IP}    ${${SERVER_PORT}}     ${resource_href}        ${NON_CONFIRMABLE}      ${payload}
    \   Run Keyword If    ${length} < 1 or ${update_support} == ${False}    Log To Console    ============== User Control -> Change state of resource for notification================
    \   Builtin.sleep   ${${DEFAULT_WAIT_TIME}}
    \	${dut2_response}	Get Observe Response	 ${COAP}    ${resource_href}
    \	Should Not Be Empty		${dut2_response}    Pre condition failed: Observe notification did not reach to client

    \	Cancel Observe Reset	${COAP}    ${resource_href}

    \   Update Representation Multiple Times    ${SERVER_IP}    ${SERVER_PORT}    ${resource_href}    ${NON_CONFIRMABLE}    ${payload}    ${update_support}    ${${CON_UPDATE_REQUIREMENT_RST}}

    \   Builtin.sleep   ${${DEFAULT_WAIT_TIME}}
    \   Clear Notifications     ${COAP}

    \   ${msgid8}    Generate Message Id
    \   ${token8}    Generate Token
    \   ${dut2_response}    Run Keyword If    ${length} > 0 and ${update_support} == ${True}    Send Post Request        ${UNICAST}      ${COAP}    ${msgid8}       ${token8}       ${SERVER_IP}    ${${SERVER_PORT}}     ${resource_href}        ${NON_CONFIRMABLE}      ${payload}
    \   Run Keyword If    ${length} < 1 or ${update_support} == ${False}    Log To Console    ============== User Control -> Change state of resource for notification================
    \   Builtin.sleep   ${${DEFAULT_WAIT_TIME}}

    \	${dut2_response}	Get Observe Response	 ${COAP}    ${resource_href}
    \	Should Be Empty		${dut2_response}    Notification for Observe received even after cancelling the observation using RESET

*** Keywords ***

Post Condition
    @{observable_resource_hrefs}	Get DUT Info Value	${HREF}	   ${DUT1_ID}	${OBSERVABLE}=1
    :FOR        ${resource_href}   IN      @{observable_resource_hrefs}
    \   ${msgid1}    Generate Message Id
    \	${dut2_response}	Cancel Observe With Get Message    ${COAP}    ${msgid1}    ${SERVER_IP}    ${${SERVER_PORT}}    ${resource_href}    ${CONFIRMABLE}
    Post Condition Crudn Server
