*** Settings ***
Documentation	CT1.7.7 Post ACL
Resource	OIC_ConformanceTest_Setting.txt
Test Setup    Start Capture
Test TearDown    End Capture

*** Test Cases ***
CT1.7.7 Post ACL
    [Documentation]					
	...	|author	| |	
	...	|reviewer|	|			
	...	|since	|2015-10-09 |
	...	|see	|Security Spec Section 10. Message Integrity and Confidentiality |
	...	|objective	|Verify the Server (DUT) can accept DTLS session with OwnerPSK and accept ACL provisioning request from the  |
	...	|objective	|Client (TE) with guaranteed message Integrity and Confidentiality. |
	...	|target	|Server DUT |
	...	|test_data| ACL |
	...	|test_configuration | Server (DUT) and Client (TE) has a pair-wise symmetric credential between them. |
	...	|pre_condition| CT1.7.6 is successfully finished |
	...	|procedure| 1. Test Application initiates a secure POST request to "/oic/sec/acl" resource in Server (DUT) to set access control policy |	
	...	|procedure| 2. DUT sends response of POST req. to ACL |
	...	|post_condition|None |
	...	|expected| 1. Secure session establishment (DTLS) between the Server (DUT) and the Client (TE).  |
	...	|expected| 2. Comparing the added ACL resource of the Server (DUT) to the ACL data of the Client (TE) and check these two are the same. |

    [Tags]	Mandatory	Security
    ${dut_response}	Get Multicast Discovery Request List	${COAP}	${OIC_CORE_PROVISION_URI}	${PROVISION_QUERY_UNOWNED}
    
    ${dut_response_code}	${resource_ip}	${resource_port}	${response_payload}	Get Response Code IP Port And Payload From Response	${dut_response}
	Should Be Equal         ${COAP_RESPONSE_CODE_SUCCESS}   ${dut_response_code}
	${payload}	Get Payload From File	${PAYLOAD_OXMSEL_JUST_WORKS}	${PAYLOAD_FILE_DIR}
	
	${message_id}	Generate Message Id
	${token}	Generate Token
	${dut_put_response}        Send Put Request        ${UNICAST}      ${COAP} 	${message_id}	${token}	${resource_ip}	  ${${resource_port}}	${OIC_CORE_PROVISION_URI}	${CONFIRMABLE}	${payload}	${PAYLOAD_TYPE_SECURITY}
	Should Not Be Empty             ${dut_put_response}
	${dut_put_response_code}	Get Response Code	${dut_put_response}
	Should Be Equal	${COAP_RESPONSE_CODE_UPDATED}	${dut_put_response_code}
	
	${dut_get_response}        Send Get Request        ${UNICAST}      ${COAP} 	${message_id}	${token}	${resource_ip}	  ${${resource_port}}	${OIC_CORE_PROVISION_PSTAT}	${CONFIRMABLE}
	Should Not Be Empty             ${dut_get_response}
	${dut_get_response_code}   Get Response Code       ${dut_get_response}
	Should Be Equal         ${COAP_RESPONSE_CODE_SUCCESS}   ${dut_get_response_code}
	
	${payload}	Get Payload From File	${PAYLOAD_PSTAT_PROVISIONING_MODE}	${PAYLOAD_FILE_DIR}
	
	${dut_put_response}        Send Put Request        ${UNICAST}      ${COAP} 	${message_id}	${token}	${resource_ip}	  ${${resource_port}}	${OIC_CORE_PROVISION_PSTAT}	${CONFIRMABLE}	${payload}	${PAYLOAD_TYPE_SECURITY}
	Should Not Be Empty             ${dut_put_response}
	${dut_put_response_code}	Get Response Code	${dut_put_response}
	
	${secured_port}	Get Secured Port	${resource_ip}	${${resource_port}}
	
	Intialize Dtls Connection	107.109.7.76	12345	${resource_ip}	${secured_port}	49176
	
	${payload}	Get Payload From File	payload_owner	${PAYLOAD_FILE_DIR}
	
	${dut_put_response}        Send Put Request        ${UNICAST}      ${COAP} 	${message_id}	${token}	107.109.7.76	  12346	${OIC_CORE_PROVISION_URI}	${CONFIRMABLE}	${payload}	${PAYLOAD_TYPE_SECURITY}
	Should Not Be Empty             ${dut_put_response}
	${dut_put_response_code}	Get Response Code	${dut_put_response}
	Should Be Equal	${COAP_RESPONSE_CODE_UPDATED}	${dut_put_response_code}
	
	${payload}	Get Payload From File	payload_acl	${PAYLOAD_FILE_DIR}
	
	${dut_put_response}        Send Post Request        ${UNICAST}      ${COAP} 	${message_id}	${token}	107.109.7.76	  12346	/oic/sec/acl	${CONFIRMABLE}	${payload}
	Should Not Be Empty             ${dut_put_response}
	${dut_put_response_code}	Get Response Code	${dut_put_response}
	Should Be Equal	${COAP_RESPONSE_CODE_CREATED}	${dut_put_response_code}
	
	Terminate Dtls Connection
